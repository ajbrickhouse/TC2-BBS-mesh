<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telemetry Data Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    
        .custom-div-icon {
            background-color: transparent;
            border: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map with a lower zoom level
        var map = L.map('map').setView([0, 0], 2); // Global view with lower zoom
    
        // Set up the OSM tile layer with lower detail and limited zoom levels
        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 17,  // Limit the maximum zoom to reduce detail
        }).addTo(map);
    
        var markers = {};  // Dictionary to store markers by sender_node_id
        var initialLoad = true;  // Flag to indicate if it's the first load
    
        // Define a list of colors to cycle through for the markers
        var markerColors = ['red', 'green', 'blue', 'orange', 'purple', 'darkred', 'cadetblue'];
        function getMarkerColor(index) {
            return markerColors[index % markerColors.length]; // Cycle through colors
        }

        // Function to generate popup content
        function generatePopupContent(item) {
            return `
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 10px;">
                            <b>${item.sender_long_name} (${item.sender_short_name})</b>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: center; padding: 5px;"><b>${item.sender_node_id}</b></td>
                        <td style="text-align: center; padding: 5px;"><b>${item.role}</b></td>
                        <td style="text-align: center; padding: 5px;"><b>${item.hardware_model}</b></td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>Last Update:</strong></td>
                        <td colspan="2" style="text-align: center;">${item.timestamp}</td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>Temperature:</strong></td>
                        <td colspan="2" style="text-align: center;">${item.temperature} Â°C</td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>Humidity:</strong></td>
                        <td colspan="2" style="text-align: center;">${item.humidity} %</td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>Pressure:</strong></td>
                        <td colspan="2" style="text-align: center;">${item.pressure} hPa</td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>Battery Level:</strong></td>
                        <td colspan="2" style="text-align: center;">${item.battery_level} %</td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>Voltage:</strong></td>
                        <td colspan="2" style="text-align: center;">${item.voltage} V</td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>Uptime:</strong></td>
                        <td colspan="2" style="text-align: center;">${item.uptime_seconds} s</td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>Altitude:</strong></td>
                        <td colspan="2" style="text-align: center;">${item.altitude} m</td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>Sats in View:</strong></td>
                        <td colspan="2" style="text-align: center;">${item.sats_in_view}</td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>SNR:</strong></td>
                        <td colspan="2" style="text-align: center;">${item.snr} dB</td>
                    </tr>
                </table>
            `;
        }
    
        // Function to fetch and update telemetry data
        function fetchTelemetryData() {
            fetch('/get-telemetry-data') // Backend endpoint for fetching data
                .then(response => response.json())
                .then(data => {
                    var bounds = [];
    
                    // Loop through the telemetry data
                    data.forEach((item, index) => {
                        // Only process points with valid latitude and longitude
                        if (item.latitude && item.longitude) {
                            bounds.push([item.latitude, item.longitude]);

                            const popupContent = generatePopupContent(item);
    
                            // If a marker for this sender_node_id already exists, update its position and popup
                            if (markers[item.sender_node_id]) {
                                markers[item.sender_node_id].baseMarker.setLatLng([item.latitude, item.longitude]);
                                markers[item.sender_node_id].labelMarker.setLatLng([item.latitude, item.longitude]);
                                markers[item.sender_node_id].baseMarker.bindPopup(popupContent);
    
                            } else {
                                // Add a regular marker for the sender_node_id
                                var baseMarker = L.marker([item.latitude, item.longitude]).addTo(map);
    
                                // Create a custom divIcon to show the short name above the marker with improved styling
                                var customLabel = L.divIcon({
                                    html: `<div style="
                                        background-color: white;
                                        border: 1px solid ${getMarkerColor(index)};
                                        border-radius: 5px;
                                        padding: 2px 5px;
                                        font-size: 14px;
                                        font-weight: bold;
                                        color: ${getMarkerColor(index)};
                                        opacity: 0.5;
                                        text-align: center;
                                        white-space: nowrap;
                                    ">${item.sender_short_name}</div>`,
                                    className: 'custom-div-icon',
                                    iconSize: [50, 30],  // Adjust the icon size dynamically
                                    iconAnchor: [25, 0]  // Offset so it appears above the marker
                                });
    
                                // Add the custom label on top of the base marker
                                var labelMarker = L.marker([item.latitude, item.longitude], { icon: customLabel }).addTo(map);
    
                                // Bind popup to the base marker (with telemetry details)
                                baseMarker.bindPopup(popupContent);
    
                                // Store both markers (base marker and label marker) in the dictionary
                                markers[item.sender_node_id] = { baseMarker, labelMarker };
                            }
                        }
                    });
    
                    // Adjust the map to fit all points only on the first load
                    if (initialLoad && bounds.length > 0) {
                        map.fitBounds(bounds);
                        initialLoad = false;  // Set to false to prevent future zooming
                    }
                })
                .catch(error => console.error('Error fetching telemetry data:', error));
        }
    
        // Fetch telemetry data every 10 seconds (10000 milliseconds)
        setInterval(fetchTelemetryData, 10000);
    
        // Initial fetch when the page loads
        fetchTelemetryData();
    </script>
</body>
</html>